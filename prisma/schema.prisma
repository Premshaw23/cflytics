generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  handle        String    @unique // Codeforces handle
  email         String?   @unique
  name          String?
  avatar        String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  bookmarks     Bookmark[]
  notes         Note[]
  goals         Goal[]
  preferences   UserPreference?
}

model Bookmark {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  problemId   String   // contestId + index (e.g., 123A)
  name        String
  rating      Int?
  createdAt   DateTime @default(now())

  @@unique([userId, problemId])
}

model Note {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  problemId   String
  content     String   @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, problemId])
}

model Goal {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        GoalType
  target      Int      // e.g., target rating or number of problems
  current     Int      @default(0)
  deadline    DateTime?
  completed   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model UserPreference {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  theme       String   @default("system")
  notifications Boolean @default(true)
}

model LoginChallenge {
  id         String    @id @default(cuid())
  handle     String
  token      String
  expiresAt  DateTime
  consumedAt DateTime?
  createdAt  DateTime  @default(now())

  @@index([handle])
  @@index([expiresAt])
}

enum GoalType {
  RATING
  PROBLEMS_SOLVED
  CONTEST_RANK
}

model Submission {
  id            String   @id @default(cuid())
  userId        String?  // Optional: for logged-in users
  problemId     String   // Codeforces problem ID (e.g., "1234-A")
  language      String
  code          String   @db.Text
  verdict       String   // AC, WA, TLE, etc.
  runtime       Float?
  memory        Int?
  testsPassed   Int
  testsTotal    Int
  tags          String[] @default([])
  rating        Int?
  createdAt     DateTime @default(now())
  
  @@index([userId])
  @@index([problemId])
  @@index([createdAt])
}

model CodeTemplate {
  id          String @id @default(cuid())
  language    String
  problemId   String
  template    String @db.Text
  
  @@unique([language, problemId])
}

model CustomTestCase {
  id             String   @id @default(cuid())
  userId         String
  problemId      String
  input          String   @db.Text
  expectedOutput String   @db.Text
  createdAt      DateTime @default(now())

  @@index([userId, problemId])
}

model SharedSolution {
  id        String   @id @default(cuid())
  code      String   @db.Text
  language  String
  problemId String
  userId    String?
  createdAt DateTime @default(now())

  @@index([id])
}

model ProblemStatement {
  id                    String   @id @default(cuid())
  problemId             String   @unique // e.g., "1234A"
  name                  String
  timeLimit             String
  memoryLimit           String
  description           String   @db.Text
  inputSpecification    String   @db.Text
  outputSpecification   String   @db.Text
  sampleTestCases       Json     // Array of {input, output}
  note                  String?  @db.Text
  tags                  String[]
  rating                Int?
  scrapedAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@index([problemId])
  @@index([rating])
}
